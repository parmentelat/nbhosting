{% extends "nbhosting.html" %}

{% block head_title %}
{{head_title}}
{% endblock %}

{% block title %}
{{title}}
{% endblock %}

{% block breadcrumb %}
<ol class="breadcrumb">
{% if user.is_authenticated and user.is_staff %}
  <li class="breadcrumb-item staff"><a href="/staff/course/{{coursename}}">{{coursename}}</a></li>
  <li class="breadcrumb-item staff"><a href="/staff/courses/">courses</a></li>
{% endif %}
    <li class="breadcrumb-item"><a href='/welcome/'>home</a></li>
    <li class="breadcrumb-item"><a href='/auditor/courses'>courses</a></li>
    <li class="breadcrumb-item active"><a href="/auditor/notebook/{{coursename}}">{{coursename}}</a></li>
</ol>
{% endblock %}

{% block content %}

{{ first_notebook_per_track|json_script:"first-notebook-per-track" }}


<!--  javascript -->
<script>

{% if jupyter_app %}
let global_track_or_app = "@{{jupyter_app}}";
{% else %}
let global_track_or_app = ":{{track.id}}";
{% endif %}

function update_header(string) {
    $('div.nbh-title>h2').html(string);
}

// make sure the current notebook
// is properly highlighted in the track area
function outline_current_notebook(notebook) {
    $("div.notebook").each(function(index, div) {
        let $div = $(div);
        let current = $div.attr("data-notebook") == notebook;
        if (current) {
            $div.addClass("current");
            update_header($div.attr("data-notebook-title"));
        } else {
            $div.removeClass("current");
        }
    })
}
// make sure no track is highlighted
function turn_off_tracks() {
    $("a.track-name").removeClass('active');
}
// turn off one of the 2 jupyter app buttons
function turn_jupyter_button(name, true_if_on) {
    let button = $(`div#${name}`);
    true_if_on ? button.addClass('active') : button.removeClass('active');
}

// update the URL bar so that page can be bookmarked or reloaded
function update_url(trailer) {
    window.history.pushState(
        {}, "", `/auditor/notebook/{{coursename}}${global_track_or_app}${trailer}`);
}

// parse map { track -> first-notebook-path }
let first_notebook_per_track = JSON.parse(
    document.getElementById('first-notebook-per-track').textContent);

// a track has been chosen
// hightlight corresponding track button,
// and turn off jup app buttons
// if show_first_button is set,
// also display first notebook in track
function select_track(track_id, show_first_notebook){
    global_track_or_app = `:${track_id}`;
    turn_jupyter_button('classic', false);
    turn_jupyter_button('jlab', false);
    // xxx need internet connection
    $(`a.track-name:not([id="sections-${track_id}-tab"])`).removeClass('active');
    $(`a.track-name[id="sections-${track_id}-tab"]`).addClass('active');
    $(`div.track-sections:not([id="sections-${track_id}"])`).removeClass('active').removeClass('show');
    $(`div.track-sections[id="sections-${track_id}"]`).addClass('active').addClass('show');

    if (show_first_notebook) {
        let notebook = first_notebook_per_track[track_id];
        if (notebook) {
            iframe_notebook(notebook);
            outline_current_notebook(notebook);
        } else {
            console.log(`Could not spot first notebook for track ${track_id}`);
        }
    }
}

function select_build(buildname, entry_point) {
  // xxx todo figure a URL scheme so as to point there directly
  // like with @classic and @jlab
  let url = `/builds/{{coursename}}/${buildname}/latest/${entry_point}`
  iframe_src(url)
}

// jupyter classic app
function select_classic() {
    global_track_or_app = "@classic";
    update_url("");
    iframe_src('/ipythonForward/{{coursename}}/{{student}}/tree');
    update_header('Jupyter classic');
    outline_current_notebook('--no-match--');
    turn_off_tracks();
    turn_jupyter_button('classic', true);
    turn_jupyter_button('jlab', false);
}
// jupyter lab app
function select_jlab(){
    global_track_or_app = "@jlab";
    update_url("");
    iframe_src('/ipythonForward/{{coursename}}/{{student}}/lab');
    update_header('Jupyter lab');
    outline_current_notebook('--no-match--');
    turn_off_tracks();
    turn_jupyter_button('classic', false);
    turn_jupyter_button('jlab', true);
}

// direct iframe to this url
// and focus input events there
function iframe_src(url) {
    $("#nbhosting-jupyter")[0].src = url;
    focus_iframe();
}
function focus_iframe() {
    $("iframe")[0].contentWindow.focus();
}

// show notebook in iframe
// track is not managed
function iframe_notebook(notebook) {
    let url=`/notebookGitRepo/{{coursename}}/${notebook}/{{student}}`;
    iframe_src(url);
    outline_current_notebook(notebook);
    update_url(`/${notebook}`);
}


////////// toggle buttons

// hide left and top areas
function hideleft_status() {
    return ($("#hideleft-toggle").hasClass("hideleft"));
}
function hideleft_toggle() {
    if ($("#hideleft-toggle").hasClass("hideleft")) {
        hideleft_off();
    } else {
        hideleft_on();
    }
    focus_iframe();
}
function hideleft_on() {
    $("#left-pane").addClass("hideleft");
    $("#iframe-container").addClass("hideleft");
    $("#hideleft-toggle").addClass("hideleft");
}
function hideleft_off() {
    $("#left-pane").removeClass("hideleft");
    $("#iframe-container").removeClass("hideleft");
    $("#hideleft-toggle").removeClass("hideleft");
}

function hidetop_status() {
    return ($("#hidetop-toggle").hasClass("hidetop"));
}
function hidetop_toggle() {
    if ($("#hidetop-toggle").hasClass("hidetop")) {
        hidetop_off();
    } else {
        hidetop_on();
    }
    focus_iframe();
}
function hidetop_on() {
    $(".nbh-banner").addClass("hidetop");
    $(".nbh-body").addClass("hidetop");
    $("#hidetop-toggle").addClass("hidetop");
}
function hidetop_off() {
    $(".nbh-banner").removeClass("hidetop");
    $(".nbh-body").removeClass("hidetop");
    $("#hidetop-toggle").removeClass("hidetop");
}


/* the left bottom area works in auto-hide mode */

function leftbottom_on() {_hide_leftbottom(false)}
function leftbottom_off() {_hide_leftbottom(true)}
function leftbottom_toggle() {
    let left_bottom = document.querySelector("#left-bottom")
    let hidden = left_bottom.getAttribute('data-hidden')
    _hide_leftbottom(! hidden)
}
function _hide_leftbottom(hidden) {
    console.log(`hidden = ${hidden}`)
    // let's get rid of jquery one day
    let left_bottom = document.querySelector("#left-bottom")
    // we're requested to make it show up: use the css setting
    if (!hidden) {
        left_bottom.style.marginBottom = null
        left_bottom.setAttribute('data-hidden', null)
    } else {
        // hidden here means to keep only 'other-views' visible
        let other_views = document.getElementById('other-views')
        let thin_height = other_views.clientHeight - 5
        let height = left_bottom.offsetHeight
        left_bottom.style.marginBottom = `${- (height - thin_height)}px`;
        left_bottom.setAttribute('data-hidden', 'yes')
    }
}
window.addEventListener(
    'load', ()=> {
        leftbottom_off()
        let left_bottom = document.querySelector("#left-bottom")
        left_bottom.addEventListener('mouseenter', leftbottom_on)
        left_bottom.addEventListener('mouseover', leftbottom_on)
        left_bottom.addEventListener('mouseout', leftbottom_off)
    })

function toggle_decorations(direction, event) {
    // with shift-click or control click
    // toggle just that direction
    if (event.shiftKey || event.metaKey
     || event.ctrlKey || event.altKey) {
        (direction == 'top') ? hidetop_toggle() : hideleft_toggle();
    } else {
        // usual click means toggle in both directions
        let top = hidetop_status()
        let left = hideleft_status()
        // except if they are not in the same status
        if (top == left) {
            hidetop_toggle()
            hideleft_toggle()
        } else {
            top ? hidetop_toggle() : hideleft_toggle()
        }
    }
}
</script>


<!--  CSS -->
<style>
html, body {
    height: 100%;
    width: 100%;
}

.nbh-banner.hidetop {
    display: none;
}

/* 102px is the header size */
#left-pane, #iframe-container {
    top: 102px;
}
/* this one is 102px - 20px (toggle height) */
#hidetop-toggle {
    top: 82px;
}
/* a bit lower to allow for the menubar */
#hideleft-toggle {
    top: 156px;
}

.nbh-body.hidetop #iframe-container, .nbh-body.hidetop #left-pane {
    top: 0px;
}
.nbh-body.hidetop #hideleft-toggle {
    top: 54px;
}

/* less space between top and left when both shown */
.nbh-body:not(.hidetop) #left-pane .#left-bottom.hidden + .left-middle > .track-sections {
    margin-top: 0px;
}
.nbh-body:not(.hidetop) #left-pane #left-top:not(.hidden) {
    margin-top: 0px;
}

#left-pane {
    display: flex;
    flex-direction: column;
    position: absolute;
    bottom: 0px;
    left: 0px;
    /*
      this means use 1/6 for the left hand side panel
      must add up with the setting for iframe-container
    */
    right: 83%;
    padding: 0px;
    background-color: #e9ecef; /* from bootstrap jumbotron */
}

#left-pane.hideleft {
    right: 100%;
}

#left-top {
    margin: 10px 10px 0px 10px;
    padding: 10px;
    border-radius: 10px;
    border: 2px solid gray;
    background-color: white;
}

div.left-middle {
    overflow-y: auto;
}

#left-bottom {
    display: flex;
    flex-direction: column;
    /* margin-top: auto is important so that
       the box gets attached to the bottom of the viewport */
    margin: auto 10px 5px 10px;
    transition: margin-bottom 0.5s ease-in-out;
    border-radius: 10px;
    /* tmp */
    border: 2px solid green;
    padding: 0px 10px 10px 10px;
    background-color: white;
}

#hidetop-toggle {
    position: fixed;
    right: 0px;
    z-index: 100;
    transform: scaleY(-1);
}

#hidetop-toggle.hidetop {
    transform: scale(1);
    top: 0px;
}

#hidetop-toggle.hideleft {
    transform: scaleX(1);
    left: 0px;
}

#hideleft-toggle {
    position: fixed;
    left: 17%;
    z-index: 100;
    transform: scaleX(-1);
}

#hideleft-toggle.hideleft {
    transform: scaleX(1);
    left: 0px;
}

#iframe-container {
    position: absolute;
    bottom: 0px;
    left: 17%;
    right: 0px;
}

#iframe-container.hideleft {
    left: 0%;
}

iframe {
    height: 100%;
}

/* ----------- */

.track-name {
    border-radius: 5px;
    border: 1px solid gray;
    margin: 5px;
    padding: 4px 16px;
    font-size: 80%;
}
.track-name:not(.active) {
    background-color: #f0f0f0;
}

div.track-sections {
    padding: 10px 10px;
    margin: 10px;
    border-radius: 10px;
    border: 2px solid blue;
    background-color: white;
}

div.section {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: flex-flex-start;
    padding-left: 10px;
    padding-right: 10px;
    padding-top: 0px;
}
div.section:last-child {
    padding-bottom: 0px;
}
.section-head {
    width: 100%;
    margin-bottom: 10px;
    font-size: 75%;
}
.notebook {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    border: 1px solid #333;
    margin: 1px;
}
div.section>a>.notebook.current {
    background-color: #ffffff;
    border: 2px solid black;
}

/* should not happen in normal usage */
.in-track {
    background-color: #ccc;
}

.in-track.in-student {
    background-color: #afa;
}
.in-student {
    background-color: #884EA0;  /* purple-ish */
}
.smaller {
    font-size: 60%;
}

iframe {
    background-image: url("/assets/img/loading.svg");
    background-repeat: no-repeat;
    background-size: 100%;
/*    background-position: center; */
 }

 #other-views {
    text-align: center;
    width: 100%;
    border-width: 0px;
    font-size: 100%;
    padding-bottom: 10px;
}

#classic, #jlab {
    width: 100%;
    font-size: 80%;
}

.transitionable {
    -webkit-transition: all 0.25s ease-in-out;
    -moz-transition: all 0.25s ease-in-out;
    -ms-transition: all 0.25s ease-in-out;
    -o-transition: all 0.25s ease-in-out;
    transition: all 0.25s ease-in-out;

}

.hidden {
    display: none;
}

.tooltip {
    pointer-events: none;
}
</style>

<!------------------------------>
<div class="container" height="100%">
    <div id="hideleft-toggle" class="transitionable">
        <img src="/assets/img/right.svg" height="40px" />
    </div>
    <div id="hidetop-toggle" class="transitionable">
        <img src="/assets/img/down.svg" height="40px" />
    </div>

    <div id="left-pane" class="transitionable">

        <div id='left-top' class='transitionable {% if tracks|length_is:"1" %}hidden{% endif%}'
            data-toggle="tooltip" data-html="true"
            title="this course<br>has several tracks"
        >

            <div class="nav flex-column nav-pills" id="track-picker-tab" role="tablist" aria-orientation="vertical">
                {% for track_obj in tracks %}
                <span data-toggle="tooltip" title="{{track_obj.description}}">
                <a class="nav-link show track-name"
                    onclick="select_track('{{track_obj.id}}', true)"
                    id="sections-{{track_obj.id}}-tab"
                    data-toggle="pill" href="#sections-{{track_obj.id}}"
                    role="tab" aria-controls="sections-{{track_obj.id}}"
                    aria-selected="{% if track.id == track_obj.id %}true{% else %}false{% endif %}"
                >{{track_obj.name}}</a>
                </span>
                {% endfor %}
            </div>
        </div>


        <div class="tab-content left-middle" id="track-picker-tabContent">

            {% for track_obj in tracks %}
            <div class="tab-pane fade track-sections transitionable"
                id="sections-{{track_obj.id}}" role="tabpanel"
                aria-labelledby="sections-{{track_obj.id}}-tab"
                >

                {% for section in track_obj.sections %}
                <div class="section">
                    <a {% autoescape off %}{{section.first_notebook.decorate_a}}{% endautoescape %}
onclick="{{section.first_notebook.onclick}}; select_track('{{track_obj.id}}', false);"
                    class="btn section-head btn-outline-primary"
                    >{{section.name}}</a>
                    {% for notebook_obj in section.notebooks %}
                    <a {% autoescape off %}{{notebook_obj.decorate_a}}{% endautoescape %}
onclick="{{notebook_obj.onclick}};select_track('{{track_obj.id}}', false);"
                    >
                        <div data-notebook="{{notebook_obj.clean_path}}"
                             data-notebook-title="{{notebook_obj.notebookname}}"
                             class="notebook {{notebook_obj.classes}}
                            {% if notebook_obj.clean_path == notebook %}current{% endif %}"
                        ></div>
                    </a>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>


        <div id="left-bottom">

            <div id="other-views"
                data-toggle="tooltip" data-html="true" data-placement="right"
                title="you'll find here<br>some other ways<br>to browse this repo">
                other views
            </div>

            {% for build in coursedir.builds %}
                <div id="build-{{build.name}}" 
                    onclick="select_build('{{build.name}}', '{{build.entry_point}}')"
                    class="build btn btn-outline-success"
                > {{build.name}}
                </div>
            {% endfor %}

            <div id="classic"
                onclick="select_classic()"
                data-toggle="tooltip" data-html="true" data-placement="right"
                title="Jupyter classic will display the contents of your workdir
                and spawn noteboks in separate tabs"
                class="classic btn btn-outline-success"
                >  Jupy<wbr>ter clas<wbr>sic
                </div>
            <div id="jlab"
                onclick="select_jlab()"
                target="nbhosting-jupyter"
                data-toggle="tooltip" data-html="true" data-placement="right"
                title="with Jupyter lab you can edit all your contents from
                within a single browser tab"
                class="lab btn btn-outline-success"
                >  Jupy<wbr>ter lab
                </div>

        </div>

    </div>

    <div id="iframe-container" class="transitionable">
        <iframe id="nbhosting-jupyter"
            height="100%"
            width="100%"
            src="{{iframe}}"
            onload="focus_iframe()"
        >
        </iframe>
    </div>
</div>

<script>
function clickleft(e) { toggle_decorations('left', e); }
function clicktop(e) { toggle_decorations('top', e); }

$(() => {
    $("#hideleft-toggle").click(clickleft);
    $("#hidetop-toggle").click(clicktop);
    {% if jupyter_app %}
        select_{{jupyter_app}}();
    {% else %}
        select_track("{{track.id}}", false);
    {% endif %}
});

</script>
{% endblock %}
